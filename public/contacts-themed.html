<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contatos • Lembretes (Tema Claro/Escuro)</title>
  <style>
    /* ---------- TOKENS ---------- */
    :root{
      --bg: #f7f8fb; --panel:#fff; --card:#fff; --text:#0f1623; --muted:#566072;
      --border:#e5e7eb; --accent:#6941FF; --accent2:#0EA5E9; --ok:#16a34a; --err:#dc2626;
      --shadow: 0 8px 24px rgba(16,24,40,.08);
    }
    body.theme-dark{
      --bg:#0b0b10; --panel:#111218; --card:#141624; --text:#eef1f6; --muted:#9aa0aa;
      --border:#23263a; --accent:#7c5cff; --accent2:#23b5d3; --ok:#22c55e; --err:#ef4444;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: linear-gradient(180deg, var(--bg), var(--bg) 60%);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    /* ---------- HEADER ---------- */
    .header{
      position: sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 20px; background: rgba(255,255,255,.8);
      backdrop-filter: blur(8px); border-bottom:1px solid var(--border);
    }
    body.theme-dark .header{ background: rgba(16,18,28,.75); }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{ width:34px; height:34px; border-radius:8px;
      background: radial-gradient(120% 120% at 0% 100%, var(--accent) 0%, #A78BFA 45%, #e5e7ff 100%);
      box-shadow: 0 6px 18px rgba(105,65,255,.35), inset 0 0 10px rgba(255,255,255,.6);
    }
    body.theme-dark .logo{
      background: radial-gradient(120% 120% at 0% 100%, var(--accent) 0%, #4a36ff 45%, #2b2f6b 100%);
      box-shadow: 0 10px 30px rgba(124,92,255,.35), inset 0 0 10px rgba(255,255,255,.12);
    }
    .title{font-weight:800; letter-spacing:.2px}
    .tag{font-size:12px; color:var(--muted); border:1px solid var(--border); padding:3px 8px; border-radius:999px; background:#fff}
    body.theme-dark .tag{ background:#0f1220; }

    /* NAV */
    .nav { display:flex; gap:10px; align-items:center; }
    .nav a{
      text-decoration:none; font-size:14px; color:var(--muted);
      border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#fff;
      transition: background .15s ease, color .15s ease, border-color .15s ease;
    }
    body.theme-dark .nav a{ background:#0f1220; }
    .nav a:hover{ background:#f5f6fa; }
    body.theme-dark .nav a:hover{ background:#12152a; }
    .nav a.active{
      color:#fff; border-color:var(--accent);
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
    }

    /* Botão inline e status */
    .navbtn{
      text-decoration:none; font-size:14px; color:#fff;
      border:1px solid var(--accent); padding:6px 12px; border-radius:999px;
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
      cursor:pointer;
    }
    .navbtn:hover{ opacity:.95; }

    .status-pill{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
      border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#fff;
    }
    body.theme-dark .status-pill{ background:#0f1220; }
    .status-dot{ width:10px; height:10px; border-radius:999px; background:#aaa; }
    .status-ok .status-dot{ background:var(--ok); }
    .status-off .status-dot{ background:var(--err); }

    /* ---------- LAYOUT ---------- */
    .container{ max-width:1200px; margin:18px auto; padding:0 16px; display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width:1024px){ .container{ grid-template-columns:320px 1fr; } }

    /* ---------- PANEL (FORM) ---------- */
    .panel{
      background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: var(--shadow);
    }
    .panel h2{ margin:0 0 8px; font-size:18px; }
    .help{ color:var(--muted); font-size:13px; margin-bottom:12px; }
    .field{ margin-bottom:12px; }
    .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .input, .button, select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#fff; color:var(--text); font-size:14px; outline:none;
    }
    body.theme-dark .input, body.theme-dark .button.secondary, body.theme-dark .search{
      background:#0f1220; color:var(--text);
    }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:540px){ .row{ grid-template-columns:1fr; } }
    .button{
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
      border:none; color:#fff; font-weight:700; cursor:pointer;
      box-shadow: 0 12px 24px rgba(105,65,255,.25);
      transition: transform .06s ease, box-shadow .2s ease, opacity .2s;
    }
    .button:hover{ transform: translateY(-1px); box-shadow: 0 16px 28px rgba(105,65,255,.28); }
    .button.secondary{ background:#fff; border:1px solid var(--border); color:var(--text); font-weight:600; }

    /* ---------- TOPBAR ---------- */
    .topbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:4px; }
    .search{ display:flex; gap:8px; align-items:center; flex:1 1 320px;
      border:1px solid var(--border); border-radius:12px; padding:8px 10px; box-shadow: var(--shadow); background:#fff;
    }
    .search input{ flex:1; border:0; background:transparent; color:var(--text); }
    .stats{ display:flex; gap:8px; align-items:center; }
    .pill{ border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); background:#fff }

    /* ---------- GRID ---------- */
    .grid{ display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .card{ background: var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:10px; box-shadow: var(--shadow); }
    .card h3{ margin:0; font-size:16px; letter-spacing:.2px; }
    .meta{ display:grid; gap:6px; font-size:13px; color:var(--muted); }
    .meta b{ color:var(--text); font-weight:600; }
    .actions{ display:flex; gap:8px; margin-top:6px; }
    .btn{ flex:1; text-align:center; padding:8px 10px; border-radius:10px; cursor:pointer; border:1px solid var(--border); font-size:13px; background:#fff; color:var(--text); transition: background .15s ease; }
    .btn:hover{ background:#f5f6fa; }
    .btn.primary{ border-color: var(--accent); color:#fff; background: linear-gradient(90deg, var(--accent), #8b5cf6); }
    .btn.primary:hover{ opacity:.95; }
    .btn.danger{ border-color:#f1c9cf; color:#b11d2a; background:#fff0f1; }
    .btn.danger:hover{ background:#ffe6e8; }
    body.theme-dark .btn{ background:#0f1220; color:var(--text); }
    body.theme-dark .btn:hover{ background:#12152a; }
    body.theme-dark .btn.danger{ border-color:#3a1f25; color:#fbc0c0; background:#1a0e12; }
    body.theme-dark .btn.danger:hover{ background:#241217; }

    .empty{ color:var(--muted); padding:24px; border:1px dashed var(--border); border-radius:16px; text-align:center; background:#fff; }
    body.theme-dark .empty{ background:#0f1220; }
    .footer{ margin:22px 0 40px; text-align:center; color:var(--muted); font-size:12px; }

    /* ---------- THEME SWITCH ---------- */
    .switch{
      display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;
      border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:#fff;
    }
    body.theme-dark .switch{ background:#0f1220; }
    .switch .dot{
      width:18px; height:18px; border-radius:999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 2px rgba(0,0,0,.03) inset;
    }
    .switch small{ color:var(--muted) }

    /* ===== MODAL ===== */
    .modal-overlay{
      position:fixed; inset:0; z-index:50;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35); backdrop-filter: blur(2px);
    }
    .modal{
      width:min(520px, 92vw);
      background:var(--panel); color:var(--text);
      border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow);
      padding:16px; transform: scale(.98); opacity:0;
      transition: transform .18s ease, opacity .18s ease;
    }
    .modal.open{ transform: scale(1); opacity:1; }
    .modal h3{ margin:0 0 8px; font-size:18px; }
    .modal .sub{ color:var(--muted); font-size:13px; margin-bottom:10px; }
    .modal .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:560px){ .modal .row{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">Lembretes • Contatos</div>
        <div class="tag" id="themeLabel">Tema Claro</div>
      </div>
    </div>

    <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      <nav class="nav">
        <a href="/contacts-themed.html" data-route="contacts">Contatos</a>
        <a href="/logs.html" data-route="logs">Logs</a>
      </nav>

      <button id="btnRunToday" class="navbtn" title="Executa /jobs/run-birthday-check?days=0">Executar hoje</button>

      <span id="srvStatus" class="status-pill">
        <span class="status-dot"></span>
        <span id="srvText">Verificando…</span>
      </span>

      <div class="switch" id="themeSwitch" title="Alternar tema (claro/escuro)">
        <div class="dot"></div>
        <small id="switchText">Alternar tema</small>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Painel de criação -->
    <aside class="panel">
      <h2>Cadastrar Novo contato</h2>
      <div class="help">Cadastre nome, e-mail, telefone e <b>data de nascimento</b> (YYYY-MM-DD).</div>

      <div class="field"><label>Nome</label><input id="name" class="input" placeholder="Ex.: Ana Souza" /></div>
      <div class="field"><label>E-mail</label><input id="email" type="email" class="input" placeholder="ana@exemplo.com" /></div>

      <div class="row">
        <div class="field"><label>Telefone</label><input id="phone" class="input" placeholder="+55 62 99999-0000" /></div>
        <div class="field"><label>Nascimento</label><input id="birthdate" type="date" class="input" /></div>
      </div>

      <div class="row">
        <button id="btnSave" class="button">Salvar contato</button>
        <button id="btnClear" class="button secondary">Limpar</button>
      </div>
    </aside>

    <!-- Área de listagem -->
    <section>
      <div class="topbar">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-3.8-3.8M17 10.5A6.5 6.5 0 1 1 4 10.5a6.5 6.5 0 0 1 13 0Z" stroke="#98a2b3" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="q" placeholder="Buscar por nome, e-mail ou telefone..." />
        </div>
        <div class="stats">
          <span class="pill" id="statTotal">— contatos</span>
          <span class="pill" id="statToday">— aniversários hoje</span>
        </div>
      </div>

      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">Nenhum contato encontrado.</div>

      <div class="footer">Tema claro/escuro com persistência — sem dependências ✨</div>
    </section>
  </main>

  <!-- ===== MODAL EDIT CONTATO ===== -->
  <div id="editOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="m_title">
      <h3 id="m_title">Editar contato</h3>
      <div class="sub">Atualize os dados do contato e salve.</div>

      <div class="field"><label for="m_name">Nome</label><input id="m_name" class="input" /></div>
      <div class="field"><label for="m_email">E-mail</label><input id="m_email" type="email" class="input" /></div>

      <div class="row">
        <div class="field"><label for="m_phone">Telefone</label><input id="m_phone" class="input" /></div>
        <div class="field"><label for="m_birth">Nascimento</label><input id="m_birth" type="date" class="input" /></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="m_save" class="button">Salvar alterações</button>
        <button id="m_cancel" class="button secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== helpers seguros ===== */
    const $ = (sel) => document.querySelector(sel);
    const $id = (id) => document.getElementById(id);
    const on = (id, evt, fn) => { const el = $id(id); if (el) el.addEventListener(evt, fn); else console.warn("[ui] elemento não encontrado #"+id); };

    async function api(path, opts = {}) {
      const r = await fetch(path, opts);
      if (!r.ok) {
        const txt = await r.text().catch(() => "");
        throw new Error(`HTTP ${r.status} on ${path} :: ${txt.slice(0,200)}`);
      }
      return r.json();
    }
    function escapeHTML(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
      ));
    }

    /* ---------- THEME ---------- */
    const THEME_KEY = "contacts_theme";
    function applyTheme(theme){
      document.body.classList.toggle("theme-dark", theme === "dark");
      $id("themeLabel").textContent = theme === "dark" ? "Tema Escuro" : "Tema Claro";
    }
    function getTheme(){ return localStorage.getItem(THEME_KEY) || "light"; }
    function toggleTheme(){
      const next = getTheme() === "dark" ? "light" : "dark";
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
    }
    (function(){ applyTheme(getTheme()); })();
    on('themeSwitch','click',toggleTheme);

    // Menu ativo
    (function setActiveNav(){
      const path = (location.pathname || "").toLowerCase();
      document.querySelectorAll('.nav a').forEach(a => {
        const href = (a.getAttribute('href') || '').toLowerCase();
        const isActive =
          (href.endsWith('/contacts-themed.html') && path.endsWith('/contacts-themed.html')) ||
          (href.endsWith('/logs.html') && path.endsWith('/logs.html'));
        if (isActive) a.classList.add('active');
      });
    })();

    // Status do servidor
    async function pingHealth(){
      const pill = $id('srvStatus'); const text = $id('srvText');
      if (!pill || !text) return;
      try{
        const r = await fetch('/health');
        if(!r.ok) throw new Error('HTTP '+r.status);
        await r.json();
        pill.classList.remove('status-off'); pill.classList.add('status-ok');
        text.textContent = 'Servidor OK';
      }catch(e){
        pill.classList.remove('status-ok'); pill.classList.add('status-off');
        text.textContent = 'Servidor off';
      }
    }
    pingHealth(); setInterval(pingHealth, 30000);

    // Executar hoje
    async function runToday(sendTo){
      const url = '/jobs/run-birthday-check?days=0' + (sendTo ? '&sendTo='+encodeURIComponent(sendTo) : '');
      const btn = $id('btnRunToday'); const prev = btn ? btn.textContent : '';
      try{
        if (btn){ btn.disabled = true; btn.textContent = 'Executando...'; }
        const r = await fetch(url, { method:'POST' });
        const j = await r.json();
        if (j.sent > 0) alert('✅ Enviado: '+j.sent+' • Pulados: '+(j.skipped||0));
        else if (j.skipped > 0) alert('ℹ️ Pulados (já havia envio hoje): '+j.skipped);
        else alert('⚠️ Nenhum lembrete enviado.\n\n'+JSON.stringify(j));
      }catch(e){ alert('Erro: '+e.message); }
      finally{
        if (btn){ btn.disabled = false; btn.textContent = prev; }
        pingHealth();
      }
    }
    on('btnRunToday','click',() => runToday());
    on('btnRunToday','mousedown',(e) => {
      if (e.shiftKey) {
        e.preventDefault();
        const email = prompt('Enviar para este e-mail específico (opcional):');
        if (email) runToday(email);
      }
    });

    /* ---------- UI/DOM ---------- */
    const grid = $id("grid");
    const empty = $id("empty");
    const q = $id("q");
    const statTotal = $id("statTotal");
    const statToday = $id("statToday");

    function card(contact){
      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.innerHTML = `
        <h3>${escapeHTML(contact.name)}</h3>
        <div class="meta">
          <div><b>E-mail:</b> ${escapeHTML(contact.email)}</div>
          <div><b>Telefone:</b> ${escapeHTML(contact.phone || "—")}</div>
          <div><b>Nascimento:</b> ${escapeHTML(contact.birthdate)}</div>
          <div class="muted">ID #${contact.id}</div>
        </div>
        <div class="actions">
          <button class="btn primary" data-email="${contact.email}">Enviar lembrete</button>
          <button class="btn" data-edit="${contact.id}">Editar</button>
          <button class="btn danger" data-id="${contact.id}">Excluir</button>
        </div>
      `;
      wrap.querySelector(".btn.danger").addEventListener("click", () => removeContact(contact.id));
      wrap.querySelector(".btn.primary").addEventListener("click", () => sendNow(contact.email));
      wrap.querySelector("[data-edit]").addEventListener("click", () => openEditModal(contact));
      return wrap;
    }

    async function load(query = "") {
      try {
        const url = query ? `/contacts?q=${encodeURIComponent(query)}` : "/contacts";
        const list = await api(url);
        if (!Array.isArray(list)) throw new Error("Resposta inesperada de /contacts");

        grid.innerHTML = "";
        if (!list.length) {
          grid.style.display = "none";
          empty.style.display = "block";
        } else {
          empty.style.display = "none";
          grid.style.display = "grid";
          list.forEach(c => grid.appendChild(card(c)));
        }

        if (statTotal) statTotal.textContent = `${list.length} contato(s)`;
        const today = new Date().toISOString().slice(5,10);
        const todayCount = list.filter(c => (c.birthdate || "").slice(5,10) === today).length;
        if (statToday) statToday.textContent = `${todayCount} hoje`;
      } catch (e) {
        console.error("[LOAD] falhou:", e);
        grid.innerHTML = `<div class="empty" style="display:block;width:100%;">Erro ao carregar contatos:<br><small>${String(e.message || e)}</small></div>`;
        grid.style.display = "block";
        empty.style.display = "none";
      }
    }

    async function save(){
      const name = $id("name").value.trim();
      const email = $id("email").value.trim();
      const phone = $id("phone").value.trim();
      const birthdate = $id("birthdate").value;
      if(!name || !email || !birthdate){
        alert("Preencha Nome, E-mail e Nascimento."); return;
      }
      await api("/contacts", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ name, email, phone, birthdate })
      });
      clearForm(); await load(q?.value.trim() || "");
    }
    on('btnSave','click',save);

    function clearForm(){
      ["name","email","phone","birthdate"].forEach(id => { const el = $id(id); if (el) el.value = ""; });
      $id("name")?.focus();
    }
    on('btnClear','click',clearForm);

    async function removeContact(id){
      if(!confirm("Excluir este contato?")) return;
      await api(`/contacts/${id}`, { method:"DELETE" });
      await load(q?.value.trim() || "");
    }

    async function sendNow(email){
      if(!email){ alert("Contato sem e-mail válido."); return; }
      if(!confirm("Enviar lembrete agora para " + email + "?")) return;
      try{
        const r = await fetch(`/jobs/run-birthday-check?days=0&sendTo=${encodeURIComponent(email)}`, { method:"POST" });
        const j = await r.json();
        if(j.sent > 0) alert("✅ Lembrete enviado com sucesso!");
        else if(j.skipped > 0) alert("ℹ️ Já havia um lembrete enviado hoje (pulado).");
        else alert("⚠️ Nenhum lembrete enviado. Resposta: " + JSON.stringify(j));
      }catch(e){ alert("Erro ao enviar: " + e.message); }
    }

    /* ===== MODAL EDIT ===== */
    let modalEditingId = null;
    const $ov = $id('editOverlay');
    const $mName  = $id('m_name');
    const $mEmail = $id('m_email');
    const $mPhone = $id('m_phone');
    const $mBirth = $id('m_birth');

    function openEditModal(contact){
      modalEditingId = contact.id;
      $mName.value  = contact.name  || "";
      $mEmail.value = contact.email || "";
      $mPhone.value = contact.phone || "";
      $mBirth.value = contact.birthdate || "";
      $ov.style.display = 'flex';
      requestAnimationFrame(() => {
        $ov.querySelector('.modal').classList.add('open');
        $mName.focus();
      });
    }
    function closeEditModal(){
      $ov.querySelector('.modal').classList.remove('open');
      setTimeout(() => { $ov.style.display = 'none'; }, 150);
      modalEditingId = null;
    }
    on('m_cancel','click',closeEditModal);
    $ov.addEventListener('click', (e) => { if (e.target === $ov) closeEditModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeEditModal(); });

    on('m_save','click', async () => {
      if (!modalEditingId) return;
      const payload = {
        name:  $mName.value.trim(),
        email: $mEmail.value.trim(),
        phone: $mPhone.value.trim(),
        birthdate: $mBirth.value
      };
      if (!payload.name || !payload.email || !payload.birthdate) {
        alert('Preencha Nome, E-mail e Nascimento.');
        return;
      }
      await api(`/contacts/${modalEditingId}`, {
        method:'PUT',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      closeEditModal();
      await load(q?.value.trim() || "");
    });

    // buscar ao digitar
    if (q) q.addEventListener("input", () => load(q.value.trim()));

    // init
    (async function(){
      try { $id('name')?.focus(); } catch {}
      await load();
      pingHealth();
    })();
  </script>
</body>
</html>
