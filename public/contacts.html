<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contatos • Lembretes de Aniversário</title>
  <style>
    :root {
      --bg: #0b0b10;
      --panel: #111218;
      --card: #141624;
      --muted: #9aa0aa;
      --text: #eef1f6;
      --accent: #7c5cff;
      --accent-2: #23b5d3;
      --border: #23263a;
      --ok: #22c55e;
      --err: #ef4444;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #0d0e14, #0a0b10 60%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    /* Header */
    .header {
      position: sticky; top: 0; z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px;
      background: rgba(16,18,28,.75);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .brand { display:flex; align-items:center; gap:10px; }
    .logo {
      width: 34px; height: 34px; border-radius: 8px;
      background: radial-gradient(120% 120% at 0% 100%, var(--accent) 0%, #4a36ff 45%, #2b2f6b 100%);
      box-shadow: 0 10px 30px rgba(124,92,255,.35), inset 0 0 10px rgba(255,255,255,.12);
    }
    .title { font-weight: 700; letter-spacing: .2px; }
    .tag { font-size: 12px; color: var(--muted); border:1px solid var(--border); padding:3px 8px; border-radius: 999px; }

    /* Layout */
    .container {
      max-width: 1200px; margin: 18px auto; padding: 0 16px;
      display: grid; grid-template-columns: 1fr; gap: 16px;
    }
    @media (min-width: 1024px) {
      .container { grid-template-columns: 320px 1fr; }
    }

    /* Panel (form) */
    .panel {
      background: linear-gradient(180deg, #141826, #11131d);
      border: 1px solid var(--border);
      border-radius: 16px; padding: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    .panel h2 {
      margin: 0 0 8px; font-size: 18px;
    }
    .help { color: var(--muted); font-size: 13px; margin-bottom: 12px; }

    .field { margin-bottom: 12px; }
    .field label { display:block; font-size: 12px; color: var(--muted); margin-bottom:6px; }
    .input, .button, select {
      width: 100%;
      padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #0f1220; color: var(--text); font-size: 14px;
      outline: none;
    }
    .input::placeholder { color: #8087a0; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 540px){ .row { grid-template-columns: 1fr; } }

    .button {
      background: linear-gradient(90deg, var(--accent), #6b8cff);
      border: none; font-weight: 700; cursor: pointer;
      box-shadow: 0 10px 25px rgba(124,92,255,.25);
      transition: transform .06s ease, box-shadow .2s ease;
    }
    .button:hover { transform: translateY(-1px); box-shadow: 0 16px 30px rgba(124,92,255,.32); }
    .button.secondary { background: #0f1220; border: 1px solid var(--border); font-weight:600; }

    /* Top actions */
    .topbar {
      display:flex; flex-wrap: wrap; gap:10px; align-items:center; justify-content: space-between;
      margin-bottom: 4px;
    }
    .search {
      display:flex; gap:8px; align-items:center; flex: 1 1 320px;
      background: #0f1220; border:1px solid var(--border); border-radius: 12px; padding: 8px 10px;
    }
    .search input { flex:1; border:0; background:transparent; color:var(--text); }
    .stats { display:flex; gap:8px; align-items:center; }
    .pill { border:1px solid var(--border); padding:6px 10px; border-radius: 999px; font-size: 12px; color: var(--muted); }

    /* Grid */
    .grid {
      display:grid; gap: 14px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      display:flex; flex-direction: column; gap:10px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    .card h3 { margin:0; font-size: 16px; letter-spacing:.2px; }
    .meta { display:grid; gap:6px; font-size: 13px; color: var(--muted); }
    .meta b { color: var(--text); font-weight:600; }
    .actions { display:flex; gap:8px; margin-top: 6px; }
    .btn {
      flex:1; text-align:center; padding:8px 10px; border-radius: 10px; cursor:pointer;
      border:1px solid var(--border); background:#0f1220; color: var(--text); font-size: 13px;
    }
    .btn:hover { background:#12152a; }
    .btn.danger { border-color: #3a1f25; color: #fbc0c0; background:#1a0e12; }
    .btn.danger:hover { background:#241217; }
    .btn.primary {
    border-color: var(--accent);
    color: #fff;
    background: linear-gradient(90deg, var(--accent), #6b8cff);
}
.btn.primary:hover { opacity: .9; }

    .empty {
      color: var(--muted); padding: 24px;
      border:1px dashed var(--border); border-radius: 16px; text-align:center;
    }

    .footer {
      margin: 22px 0 40px; text-align:center; color:var(--muted); font-size:12px;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">Lembretes • Contatos</div>
        <div class="tag">MVP</div>
      </div>
    </div>
    <div class="tag">Responsivo</div>
  </header>

  <main class="container">
    <!-- Painel de criação -->
    <aside class="panel">
      <h2>Novo contato</h2>
      <div class="help">Cadastre nome, e-mail, telefone e <b>data de nascimento</b> (YYYY-MM-DD).</div>

      <div class="field">
        <label>Nome</label>
        <input id="name" class="input" placeholder="Ex.: Ana Souza" />
      </div>

      <div class="field">
        <label>E-mail</label>
        <input id="email" type="email" class="input" placeholder="ana@exemplo.com" />
      </div>

      <div class="row">
        <div class="field">
          <label>Telefone</label>
          <input id="phone" class="input" placeholder="+55 62 99999-0000" />
        </div>
        <div class="field">
          <label>Nascimento</label>
          <input id="birthdate" type="date" class="input" />
        </div>
      </div>

      <div class="row">
        <button id="btnSave" class="button">Salvar contato</button>
        <button id="btnClear" class="button secondary">Limpar</button>
      </div>
    </aside>

    <!-- Área de listagem -->
    <section>
      <div class="topbar">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-3.8-3.8M17 10.5A6.5 6.5 0 1 1 4 10.5a6.5 6.5 0 0 1 13 0Z" stroke="#9aa0aa" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="q" placeholder="Buscar por nome, e-mail ou telefone..." />
        </div>
        <div class="stats">
          <span class="pill" id="statTotal">— contatos</span>
          <span class="pill" id="statToday">— aniversários hoje</span>
        </div>
      </div>

      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">Nenhum contato encontrado.</div>

      <div class="footer">Feito com ❤️ para seu MVP — responsivo e sem dependências.</div>
    </section>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const grid = $("#grid");
    const empty = $("#empty");
    const q = $("#q");
    const statTotal = $("#statTotal");
    const statToday = $("#statToday");

    async function api(path, opts={}){
      const r = await fetch(path, opts);
      if(!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    }

    function card(contact){
      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.innerHTML = `
        <h3>${escapeHTML(contact.name)}</h3>
        <div class="meta">
          <div><b>E-mail:</b> ${escapeHTML(contact.email)}</div>
          <div><b>Telefone:</b> ${escapeHTML(contact.phone || "—")}</div>
          <div><b>Nascimento:</b> ${escapeHTML(contact.birthdate)}</div>
          <div class="muted">ID #${contact.id}</div>
        </div>
        <div class="actions">
            <button class="btn primary" data-email="${contact.email}">Enviar lembrete</button>
          <button class="btn danger" data-id="${contact.id}">Excluir</button>
        </div>
      `;
      wrap.querySelector(".btn.danger").addEventListener("click", () => removeContact(contact.id));
      wrap.querySelector(".btn.primary").addEventListener("click", () => sendNow(contact.email));
      return wrap;
    }

    function escapeHTML(s) {
        return String(s ?? "").replace(/[&<>"']/g, m => (
            {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
}

    async function load(query=""){
      const url = query ? `/contacts?q=${encodeURIComponent(query)}` : "/contacts";
      const list = await api(url);
      grid.innerHTML = "";
      if(!list.length){ grid.style.display="none"; empty.style.display="block"; }
      else {
        empty.style.display="none"; grid.style.display="grid";
        list.forEach(c => grid.appendChild(card(c)));
      }
      statTotal.textContent = `${list.length} contato(s)`;
      // aniversários de hoje (só client-side)
      const today = new Date().toISOString().slice(5,10); // "MM-DD"
      const todayCount = list.filter(c => (c.birthdate||"").slice(5,10) === today).length;
      statToday.textContent = `${todayCount} hoje`;
    }

    async function save(){
      const name = $("#name").value.trim();
      const email = $("#email").value.trim();
      const phone = $("#phone").value.trim();
      const birthdate = $("#birthdate").value;
      if(!name || !email || !birthdate){
        alert("Preencha Nome, E-mail e Nascimento."); return;
      }
      await api("/contacts", {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ name, email, phone, birthdate })
      });
      clearForm();
      await load(q.value.trim());
    }

    async function removeContact(id){
      if(!confirm("Excluir este contato?")) return;
      await api(`/contacts/${id}`, { method:"DELETE" });
      await load(q.value.trim());
    }

    async function sendNow(email){
  if(!email) { alert("Contato sem e-mail válido."); return; }
  if(!confirm("Enviar lembrete agora para " + email + "?")) return;
  try {
    const r = await fetch(`/jobs/run-birthday-check?days=0&sendTo=${encodeURIComponent(email)}`, { method:"POST" });
    const j = await r.json();
    if(j.sent > 0) alert("✅ Lembrete enviado com sucesso!");
    else if(j.skipped > 0) alert("ℹ️ Já havia um lembrete enviado hoje (pulado).");
    else alert("⚠️ Nenhum lembrete enviado. Resposta: " + JSON.stringify(j));
  } catch(e){
    alert("Erro ao enviar: " + e.message);
  }
}


    function clearForm(){
      $("#name").value = "";
      $("#email").value = "";
      $("#phone").value = "";
      $("#birthdate").value = "";
      $("#name").focus();
    }

    // events
    $("#btnSave").addEventListener("click", save);
    $("#btnClear").addEventListener("click", clearForm);
    q.addEventListener("input", () => { load(q.value.trim()); });

    // init
    (async function(){
      // default: foco no nome
      $("#name").focus();
      // hoje no input date (opcional)
      // $("#birthdate").value = new Date().toISOString().slice(0,10);
      await load();
    })();
  </script>
</body>
</html>
